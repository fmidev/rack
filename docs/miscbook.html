<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Miscellaneous commands and scripts</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="rack.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="rack-logo-110x55.png"/></td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Sections</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Miscellaneous commands and scripts </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="Introduction"></a>
Introduction</h1>
<p>This section explains general commands and useful hints in using <b>Rack</b>.</p>
<h1><a class="anchor" id="modifying"></a>
Modifying data</h1>
<h2><a class="anchor" id="deleting"></a>
Deleting data</h2>
<p>The h5 structure can be pruned with <code>&ndash;delete</code> command which uses selector arguments similar to that of <code>&ndash;select</code> (see <a class="el" href="index.html#selecting">Selecting data</a>).</p>
<p>Examples: </p><div class="fragment"><div class="line"><span class="preprocessor"># Delete dataset[i] groups 2...10 </span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --<span class="keyword">delete</span> dataset=2:10 -o volume-modified.h5</div><div class="line"></div><div class="line"><span class="preprocessor"># Delete data[i] groups 3...20</span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --<span class="keyword">delete</span> data=3:20 -o volume-modified.h5</div><div class="line"></div><div class="line"><span class="preprocessor"># Delete data[i] groups 3...20, in dataset[i] groups 2...10</span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --<span class="keyword">delete</span> dataset=2:10,data=3:20 -o volume-modified.h5</div><div class="line"></div><div class="line"><span class="preprocessor"># Delete independently dataset[i] and data[i] groups: issue two commands</span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --<span class="keyword">delete</span> dataset=2:6 --<span class="keyword">delete</span> data=2:5 -o volume-modified.h5</div><div class="line"></div><div class="line"><span class="preprocessor"># Delete data[i] groups containing VRAD</span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --<span class="keyword">delete</span> quantity=VRAD -o volume-modified.h5</div><div class="line"></div><div class="line"><span class="preprocessor"># Delete data[i] groups containing VRAD in 1.0 degree sweeps and above</span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --<span class="keyword">delete</span> elangle=1.0:90,quantity=VRAD -o volume-modified.h5</div><div class="line"></div><div class="line"><span class="preprocessor"># Delete data (array) groups </span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --<span class="keyword">delete</span> groups=array -o volume-modified.h5</div><div class="line"></div><div class="line"><span class="preprocessor"># Delete quality[i] groups </span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --<span class="keyword">delete</span> groups=quality -o volume-modified.h5</div><div class="line"></div></div><!-- fragment --><p>Notice that <code>&ndash;elangle</code> applies to volume data only, and essentially selects <code>dataset</code> groups. Similarly, <code>quantity</code> selects <code>data</code> (and <code>quality</code>) groups. If selection parameters of both levels are issued in the same command, implicit <code>AND</code> function applies in selection.</p>
<h2><a class="anchor" id="keeping"></a>
Keeping some, deleting other</h2>
<p>Alternatively, one may use the complement operation <code>&ndash;keep</code> to save part of the data.</p>
<p>Metadata groups (<code>what</code>, <code>where</code>, <code>how</code>) are preserved or deleted together with their parent groups.</p>
<p>Examples: </p><div class="fragment"><div class="line"><span class="preprocessor"># Keep data[i] groups containg DBZH</span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --keep quantity=DBZH -o volume-modified.h5</div><div class="line"></div><div class="line"><span class="preprocessor"># Keep dataset[i] groups containing (at least) VRAD</span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --keep quantity=VRAD -o volume-modified.h5</div><div class="line"></div><div class="line"><span class="preprocessor"># Keep dataset[i] group with elangle 5.0 degrees, at lowest</span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --keep elangle=5.0:90.0 -o volume-modified.h5</div><div class="line"></div><div class="line"><span class="preprocessor"># Keep three dataset[i] groups with lowest elangle </span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --keep elangle=-90.0:90.0,count=3 -o volume-modified.h5</div><div class="line"></div><div class="line"><span class="preprocessor"># Keep quality[i] groups</span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --keep groups=quality -o volume-modified.h5</div><div class="line"></div></div><!-- fragment --><h2><a class="anchor" id="renaming"></a>
Renaming and moving paths and attributes</h2>
<p>One can rename existing paths (hdf5 group names) and attributes with <code>&ndash;move</code> command.</p>
<p>Rename or move data groups and attributes. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">src</td><td>- source path consisting at least of the group path </td></tr>
    <tr><td class="paramname">dst</td><td>- full destination path or only ':' followed by attribute key</td></tr>
  </table>
  </dd>
</dl>
<p>A full path consist of a slash-separated group path elements followed by an attribute key separated by colon. For example: <code>/dataset1/data2/what</code>:gain .</p>
<p>Examples: </p><div class="fragment"><div class="line"><span class="preprocessor"># Move group</span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --move dataset1/quality1,dataset1/data1/quality3 -o volume-modified.h5</div><div class="line"></div><div class="line"><span class="preprocessor"># Rename only the attribute key</span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --move dataset1/how:task,:newtask -o volume-modified.h5</div><div class="line"></div><div class="line"><span class="preprocessor"># Move attribute in hierarchy</span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --move dataset1/how:task,what -o volume-modified.h5</div><div class="line"></div><div class="line"><span class="preprocessor"># Move and rename attribute</span></div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --move dataset1/where:nrays,dataset1/how:imageheight -o volume-modified.h5</div><div class="line"></div></div><!-- fragment --><h2><a class="anchor" id="conversions"></a>
Data conversions</h2>
<p>Volume data can be converted to desired scale and encoding with <code>&ndash;encoding</code> followed by <code>&ndash;convert</code> . If the input file contains several quantities, the target quantity can be selected with <code>&ndash;select</code> (<code>-s</code>) command:</p>
<div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> volume-<span class="keywordtype">double</span>.h5 -Q DBZH --encoding C,0.5,-32 --convert  -o volume-<span class="keyword">new</span>.h5</div><div class="line"><a class="code" href="namespacerack.html">rack</a> volume-uint16.h5 -Q DBZH --encoding d --convert -Q VRAD --encoding C,0.025,-7.65506,0,255 --convert -o volume-<span class="keyword">new</span>.h5</div></div><!-- fragment --><h1><a class="anchor" id="scripts"></a>
Scripts</h1>
<p>If a fixed set of commands &ndash; a script &ndash; is needed for each input, one may define it with <code>&ndash;script</code> . The script is then executed automatically for each input:</p>
<div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> --script <span class="stringliteral">&#39;&lt;commands&gt;&#39;</span>  &lt;file&gt; &lt;file2&gt; &lt;file3&gt; ...</div></div><!-- fragment --><p>The functionality is handy for example in running anomaly detection and product generation for a set of files. Defining a script also turns on <em>variable</em> <em>expansion</em> . The automatic execution can be reset with <code>&ndash;autoExec</code> 0, and the script is executed only upon issuing <code>&ndash;exec</code> .</p>
<p>Instead of the command line, one may also execute commands stored in a file as follows:</p>
<div class="fragment"><div class="line">rack &lt;file&gt;  --executeFile &lt;cmdFile&gt;   </div></div><!-- fragment --><p>Note that plain filenames are implicit <code>&ndash;inputFile</code> commands; hence a command file can be a list of input files. Using such file together with <code>&ndash;script</code> yields compact command lines especially in compositing.</p>
<h1><a class="anchor" id="pointmeasurements"></a>
Adding point measurements</h1>
<p>Also external point measurements - like ground station observations - can be projected into a Cartesian product. Technically, the procedure works as in compositing, which applies internally an accumulation array: adding data from a single radar is equal to adding several single observations.</p>
<p>Everything starts by creating an empty accumulation array with <code>&ndash;cSize</code> and <code>&ndash;cProj</code> commands; sometimes <code>&ndash;cMethod</code> may apply as well. Alternatively, the array can be initialised with a radar composite by loading it with <code>&ndash;cLoad</code> . Moreover, plotting can be arbitrarily mixed with single radar observations; weighting can be applied in tuning the between radars and ground observations.</p>
<p>Single entries can be added in a command line with <code>&ndash;cPlot</code> command. The command has the form </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> &lt;composite-settings&gt; --cPlot &lt;lon&gt;,&lt;lat&gt;,&lt;intensity&gt;[,&lt;weight&gt;] [...] --cExtract dw  [--cSpread &lt;spread&gt;]  &lt;output-commands&gt; </div></div><!-- fragment --><p> The plotting command takes longitude, latitude and intensity as parameters. Intensity is the magnitude of the user defined quantity, say rain rate. A weight parameter can be associated to each observation. After extraction, the pointwise intensities can be spread coarsely as ellipses using <code>&ndash;cSpread</code> , which takes horizonal and vertical radii in kilometres as arguments. Like any other products, the result can be stored in an HDF5 or image file.</p>
<p>Applying many subsequent <code>&ndash;cPlot</code> commands is clumsy. Assume that you have file <code>measurements.dat</code> containing comma separated entries of lon,lat, and measurement value, like</p>
<div class="fragment"><div class="line"><span class="preprocessor"># lon,lat,mmh</span></div><div class="line">  20.78302  69.03332         0</div><div class="line">  20.78302  69.03332         0</div><div class="line">  23.96628  66.76636         0</div><div class="line">  23.96628  66.76636         0</div><div class="line">  24.71638  64.03332        .6</div><div class="line">...</div><div class="line">    ...</div><div class="line">        ...</div><div class="line">  26.96628  65.38318         0</div><div class="line">  26.96628  65.38318         0</div><div class="line">   29.1666  67.14994         0</div><div class="line">   25.0833  64.68306         0</div><div class="line">  29.31654  66.36652         0</div></div><!-- fragment --><p>then you can plot them with <code>&ndash;cPlotFile</code> command as follows:</p>
<div class="fragment"><div class="line">BBOX=&#39;17,57.75,32.75,70&#39;</div><div class="line">SIZE=&#39;500,750&#39;</div><div class="line"></div><div class="line">rack  --cProj &#39;+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs&#39; --cBBox $BBOX  --cSize $SIZE  \</div><div class="line">  --cQuantity RATE --cPlotFile measurements.dat \</div><div class="line">  --encoding C,0.01,undetect=1,nodata=0 \</div><div class="line">  --cExtract dw \</div><div class="line">  -o plot.png \</div><div class="line">  --iDistanceTransformFill 5 \</div><div class="line">  -o plot-spread1.png  \</div><div class="line">  --iGaussianAverage 15 \</div><div class="line">  --iAverage 15 \</div><div class="line">  --iGaussianAverage 15 \</div><div class="line">  -o plot-spread2.png  \</div><div class="line">  --palette palette-RATE.txt --paletteRefine 64 --imageTransp 0:2 -o plot-spread-color.png  </div><div class="line">#  --palette palette-RATE.txt --paletteRefine 64 --encoding &#39;C,0.2,-32,1,100&#39; --imageAlpha -o plot-spread-color.png</div><div class="line"></div><div class="line"></div></div><!-- fragment --><p>For further processing, it may be needed to add several ODIM variables as in the above script.</p>
<div class="image">
<img src="plots.png" alt="plots.png"/>
<div class="caption">
Rainfall observations plotted and spread to 50km circles (left) and similar 100km circles coloured with <code>--palette</code> and superposed on a map (right).</div></div>
 <h1><a class="anchor" id="sampling"></a>
Sampling grid data</h1>
<p>The input volume as well as the generated polar or Cartesian products can be sampled, producing a text file. The sampling is performed automatically if output file has the extension '.dat'. For example: </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 -o samples.dat</div></div><!-- fragment --><p>The result: </p><div class="fragment"><div class="line"><span class="preprocessor"># proj=&#39; +proj=aeqd +lon_0=26.3189 +lat_0=64.7749 +ellps=WGS84&#39;</span></div><div class="line"><span class="preprocessor"># bbox=&#39;26.319,67.9454,26.3189,67.9454&#39;</span></div><div class="line"><span class="preprocessor"># size=&#39;500x360&#39;</span></div><div class="line"><span class="preprocessor"># iStep=10</span></div><div class="line"><span class="preprocessor"># jStep=10</span></div><div class="line"><span class="preprocessor"># sampleRows=50</span></div><div class="line"><span class="preprocessor"># sampleCols=36</span></div><div class="line"><span class="preprocessor"># samples=1800</span></div><div class="line"><span class="preprocessor"># format=&#39;${i},${j},${LON},${LAT},${X},${Y},${RANGE},${AZM},${DBZH},${DBZHC},${HCLASS},${KDP},${RHOHV},${SQI},${TH},${VRAD},${WRAD},${ZDR}&#39;</span></div><div class="line">5,5,26.3239,64.7995,239.678,2739.54,2750,5,0,0,0,0,0,0.212275,37.5,0,0,0 #<span class="keywordtype">void</span> data</div><div class="line">15,5,26.3331,64.8441,675.457,7720.51,7750,5,0,0,0,0,0,0.162971,38,0,0,0 #<span class="keywordtype">void</span> data</div><div class="line">35,5,26.3516,64.9335,1547.01,17682.5,17750,5,0,0,0,0,0,0.326263,38.5,0,0,0 #<span class="keywordtype">void</span> data</div><div class="line">45,5,26.3609,64.9782,1982.79,22663.4,22750,5,0,0,0,0,0,0.285078,15.5,0,0,0 #<span class="keywordtype">void</span> data</div><div class="line">105,5,26.4173,65.2462,4597.47,52549.3,52750,5,0,0,0,0,0,0.0657837,0,0,0,0 #<span class="keywordtype">void</span> data</div><div class="line">25,5,26.3424,64.8888,1111.24,12701.5,12750,5,11,11,2,0,0.994507,0.826271,17.5,-6.51876,0.992188,0.04</div><div class="line">55,5,26.3702,65.0228,2418.57,27644.4,27750,5,-5.5,-5.5,1,0.01,0.0921368,0.640532,-4,-7.41583,0.0742188,8.92</div><div class="line">65,5,26.3796,65.0675,2854.35,32625.4,32750,5,-7,-7,1,0.01,0.953184,0.816047,-6.5,-6.87759,0.992188,-0.48</div><div class="line">75,5,26.3889,65.1122,3290.13,37606.3,37750,5,15,15.5,2,0.03,0.98883,0.897899,15,6.93739,0.992188,1.11</div><div class="line">85,5,26.3983,65.1569,3725.91,42587.3,42750,5,-12.5,45.5,1,-0.03,0.64775,0.067157,-12.5,6.87759,0.0742188,-0.28</div><div class="line">...</div><div class="line">    ...</div><div class="line">        ...</div><div class="line">455,355,25.8675,66.809,-19849.7,226883,227750,355,6.5,6.5,4,-0.08,0.783865,0.356263,6.5,-2.21279,0.0742188,0.4</div><div class="line">465,355,25.8567,66.8536,-20285.5,231864,232750,355,4,4,4,-0.06,0.931653,0.353257,4,-1.79415,0.992188,0.04</div><div class="line">475,355,25.8459,66.8983,-20721.3,236845,237750,355,4.5,4.5,1,0.16,0.819084,0.304259,4.5,-1.31571,0.0742188,-1.25</div><div class="line">485,355,25.8351,66.9429,-21157.1,241826,242750,355,6,6,4,0.32,0.835854,0.420826,5.5,-2.57162,0.992188,-0.1</div><div class="line">495,355,25.8242,66.9875,-21592.8,246807,247750,355,7,7,4,0.42,0.771184,0.307814,7,-1.79415,0.992188,0.91</div></div><!-- fragment --><p>The default sampling step is 10 in both horizontal and vertical direction, and all the quantities are sampled. One may apply <code>&ndash;select</code> command to get desired subset of quantities. Further, <code>&ndash;format</code> can be applied for modifying output layout; variables marked like <code>${NAME}</code> are converted to actual values in output:</p><ul>
<li><em>i</em> , <em>j</em> and <em>j2:</em> image coordinates, from top-left corner (bin and azimuth index in polar sampling);</li>
<li><em>j2:</em> inverted vertical image coordinate ie. from bottom-left corner</li>
<li><em>LON</em> and <em>LAT</em> : geographical coordinates, in degreees</li>
<li><em>X</em> and <em>Y</em> : map coordinates, in metres</li>
<li><em>AZM</em> and <em>RANGE:</em> polar coordinates (applicable in polar sampling only)</li>
<li>the quantities, eg. <code>DBZH</code> , <code>VRAD</code> , and so one, including quality quantities like <code>QIND</code>. The default format consists of all the applicable coordinates and quantities separated by space. Values can be negated by putting a minus sign inside the curly braces of a format string.</li>
</ul>
<p>Sampling steps, start, and end can be changed with <code>&ndash;sample</code> command. One may also skip lines containing <code>undetect</code> or <code>nodata</code> samples. If a comment char is defined, the applied format appears as a comment in the start of the output.</p>
<div class="fragment"><div class="line">--sample  &lt;iStep&gt;,&lt;jStep&gt;,&lt;iRange&gt;,&lt;jRange&gt;,&lt;commentChar&gt;,&lt;skipVoid&gt;,&lt;iStart&gt;,&lt;jStart&gt;,&lt;iEnd&gt;,&lt;jEnd&gt;</div><div class="line">  Extract samples. See --format.</div><div class="line">    iStep=10 [horz coord step]</div><div class="line">    jStep=0 [vert coord step]</div><div class="line">    iRange=-1:-1 [horz range]</div><div class="line">    jRange=-1:-1 [vert range]</div><div class="line">    commentChar=# [comment prefix (<span class="keywordtype">char</span> or bytevalue)]</div><div class="line">    skipVoid=<span class="keyword">false</span> [skip lines with invalid/missing values]</div><div class="line">    iStart=-1 [horz coord start (obsolete)]</div><div class="line">    jStart=-1 [vert coord start (obsolete)]</div><div class="line">    iEnd=-1 [horz coord end (obsolete)]</div><div class="line">    jEnd=-1 [vert coord end (obsolete)]</div></div><!-- fragment --><p> Example of a formatted sampling: </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --select quantity=DBZH --sample 10,30,iStart=50,iEnd=200 --format <span class="stringliteral">&#39;${i},${j2} (${LON},${LAT}) ${DBZH}&#39;</span> -o samples-formatted.dat</div></div><!-- fragment --><p>The result: </p><div class="fragment"><div class="line"><span class="preprocessor"># proj=&#39; +proj=aeqd +lon_0=26.3189 +lat_0=64.7749 +ellps=WGS84&#39;</span></div><div class="line"><span class="preprocessor"># bbox=&#39;26.319,67.9454,26.3189,67.9454&#39;</span></div><div class="line"><span class="preprocessor"># size=&#39;500x360&#39;</span></div><div class="line"><span class="preprocessor"># iStep=10</span></div><div class="line"><span class="preprocessor"># jStep=30</span></div><div class="line"><span class="preprocessor"># sampleRows=50</span></div><div class="line"><span class="preprocessor"># sampleCols=12</span></div><div class="line"><span class="preprocessor"># samples=600</span></div><div class="line"><span class="preprocessor"># format=&#39;${i},${j2} (${LON},${LAT}) ${DBZH}&#39;</span></div><div class="line">80, (26.5407,65.1234) 0 #<span class="keywordtype">void</span> data</div><div class="line">90, (26.5687,65.1667) 0 #<span class="keywordtype">void</span> data</div><div class="line">100, (26.5968,65.21) 0 #<span class="keywordtype">void</span> data</div><div class="line">110, (26.6249,65.2533) 0 #<span class="keywordtype">void</span> data</div><div class="line">120, (26.6532,65.2965) 0 #<span class="keywordtype">void</span> data</div><div class="line">130, (26.6815,65.3398) 0 #<span class="keywordtype">void</span> data</div><div class="line">140, (26.7099,65.383) 0 #<span class="keywordtype">void</span> data</div><div class="line">150, (26.7384,65.4262) 0 #<span class="keywordtype">void</span> data</div><div class="line">50, (26.4574,64.9936) -16.5</div><div class="line">60, (26.4851,65.0369) -15.5</div><div class="line">70, (26.5129,65.0802) 20.5</div><div class="line">60, (26.7717,64.9661) 10.5</div><div class="line">70, (26.8472,64.9975) 8.5</div><div class="line">...</div><div class="line">    ...</div><div class="line">        ...</div><div class="line">150, (25.8994,65.4262) 0 #<span class="keywordtype">void</span> data</div><div class="line">160, (25.8708,65.4695) 0 #<span class="keywordtype">void</span> data</div><div class="line">170, (25.842,65.5127) 0 #<span class="keywordtype">void</span> data</div><div class="line">180, (25.8132,65.5559) -4</div><div class="line">190, (25.7843,65.5992) 7</div></div><!-- fragment --><p>Likewise, one can sample Cartesian data. Example: </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --select quantity=DBZH --cSize 500,500 -c --sample 50,50  -o samples-cart.dat</div></div><!-- fragment --><p>The result: </p><div class="fragment"><div class="line"><span class="preprocessor"># proj=&#39; +proj=aeqd +lon_0=26.3189 +lat_0=64.7749 +ellps=WGS84&#39;</span></div><div class="line"><span class="preprocessor"># BBOX=&#39;21.4998,62.4478 32.0057,66.9162&#39;</span></div><div class="line"><span class="preprocessor"># XRANGE=&#39;21.4998:32.0057&#39;</span></div><div class="line"><span class="preprocessor"># YRANGE=&#39;62.4478:66.9162&#39;</span></div><div class="line"><span class="preprocessor"># size=&#39;500x500&#39;</span></div><div class="line"><span class="preprocessor"># iStep=50</span></div><div class="line"><span class="preprocessor"># jStep=50</span></div><div class="line"><span class="preprocessor"># sampleRows=10</span></div><div class="line"><span class="preprocessor"># sampleCols=10</span></div><div class="line"><span class="preprocessor"># samples=100</span></div><div class="line"><span class="preprocessor"># format=&#39;${i},${j},${LON},${LAT},${X},${Y},${j2},${DBZH},${QIND}&#39;</span></div><div class="line">25,25,21.2565,66.7078,-223270,224500,474,0,0 #<span class="keywordtype">void</span> data</div><div class="line">75,25,22.3806,66.7396,-173544,224500,474,0,0 #<span class="keywordtype">void</span> data</div><div class="line">125,25,23.5072,66.7635,-123818,224500,474,0,0 #<span class="keywordtype">void</span> data</div><div class="line">175,25,24.6357,66.7794,-74091.9,224500,474,0,0.5 #<span class="keywordtype">void</span> data</div><div class="line">325,25,28.0247,66.7792,75086.4,224500,474,0,0.5 #<span class="keywordtype">void</span> data</div><div class="line">375,25,29.1531,66.7631,124812,224500,474,0,0 #<span class="keywordtype">void</span> data</div><div class="line">425,25,30.2797,66.7391,174539,224500,474,0,0 #<span class="keywordtype">void</span> data</div><div class="line">225,25,25.7652,66.7873,-24365.8,224500,474,8,0.5</div><div class="line">275,25,26.8952,66.7872,25360.3,224500,474,5.5,0.5</div><div class="line">225,75,25.7751,66.339,-24365.8,174500,424,13.5,0.5</div><div class="line">175,125,24.6945,65.883,-74091.9,124500,374,11,0.5</div><div class="line">225,125,25.7846,65.8906,-24365.8,124500,374,6,0.5</div><div class="line">...</div><div class="line">    ...</div><div class="line">        ...</div><div class="line">275,475,26.8151,62.7511,25360.3,-225500,24,0,0.5 #<span class="keywordtype">void</span> data</div><div class="line">325,475,27.7877,62.7442,75086.4,-225500,24,0,0.5 #<span class="keywordtype">void</span> data</div><div class="line">375,475,28.7596,62.7305,124812,-225500,24,0,0 #<span class="keywordtype">void</span> data</div><div class="line">425,475,29.7304,62.7101,174539,-225500,24,0,0 #<span class="keywordtype">void</span> data</div><div class="line">475,475,30.6997,62.6828,224265,-225500,24,0,0 #<span class="keywordtype">void</span> data</div></div><!-- fragment --><p>Note that <code>&ndash;cCreate</code> maps a single quantity to Cartesian coordinates; the quantity can be changed with <code>&ndash;select</code> .</p>
<h1><a class="anchor" id="templates"></a>
Metadata output using text templates</h1>
<p>There is often need to produce metadata text for:</p><ul>
<li>Log entries</li>
<li>HTML files applied in monitoring product generation</li>
<li>Text files provided in parallel with data formats not supporting metadata</li>
<li>Graphical end products based on element layouts (eg. SVG)</li>
<li>Geographic definition files (eg. KML) for adding radar products to GIS applications</li>
</ul>
<p>One can easily export metadata of current HDF5 structure (latest volume read or product generated). The output is a text file in which variables <code>${variable}</code> have been expanded to their current values.</p>
<p>The text template can be defined briefly on command line by <code>&ndash;format</code> or by reading a file with <code>&ndash;formatFile</code> .</p>
<p>For example, from a Cartesian product one may extract the projection and a bounding box with the following command: </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 -c  --format <span class="stringliteral">&#39;BBOX=${where:LL_lon},${where:LL_lat},${where:UR_lon},${where:UR_lat}\n&#39;</span> --formatOut formatOut.txt </div></div><!-- fragment --><p>The result: </p><div class="fragment"><div class="line">BBOX=21.4998,62.4478,32.0057,66.9162</div></div><!-- fragment --><p>The applicable variables are those the ODIM variables (what:product, where:lat, ...). In addition, <code>what:source</code> fields (<code>NOD</code>, <code>WMO</code> , <code>RAD</code> , <code>PLC</code> , <code>CMT</code> ) are searched for and expanded to convenience variables (<code>${NOD}</code>, etc...). The list of current variables can be examined with <code>&ndash;status</code> command.</p>
<p>For example, assume template file <code>radar-conf.tpl</code> with the following contents:</p>
<div class="fragment"><div class="line"># Metadata for radar &#39;${NOD}&#39;</div><div class="line"></div><div class="line">SOURCE=&quot;${what:source}&quot;</div><div class="line">NOD=&quot;${NOD}&quot;</div><div class="line">WMO=&quot;${WMO}&quot;</div><div class="line">PLC=&quot;${PLC}&quot;</div><div class="line">LAT=&quot;${where:lat}&quot;</div><div class="line">LON=&quot;${where:lon}&quot;</div><div class="line">HEIGHT=&quot;${where:height}&quot;</div><div class="line">PROJDEF=&quot;${where:projdef}&quot;</div><div class="line">BBOX=&quot;${where:LL_lon},${where:LL_lat},${where:UR_lon},${where:UR_lat}&quot;</div></div><!-- fragment --><p>Then, </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 -c --formatFile radar-conf.tpl --formatOut out.cnf  </div></div><!-- fragment --><p> produces code which can be used by applications supporting <b>Proj4</b> projection syntax. The result:</p>
<div class="fragment"><div class="line"># Metadata for radar &#39;fiuta&#39;</div><div class="line"></div><div class="line">SOURCE=&quot;WMO:02870,RAD:FI47,PLC:Utajärvi,NOD:fiuta&quot;</div><div class="line">NOD=&quot;fiuta&quot;</div><div class="line">WMO=&quot;02870&quot;</div><div class="line">PLC=&quot;Utajärvi&quot;</div><div class="line">LAT=&quot;64.7749&quot;</div><div class="line">LON=&quot;26.3189&quot;</div><div class="line">HEIGHT=&quot;118&quot;</div><div class="line">PROJDEF=&quot; +proj=aeqd +lon_0=26.3189 +lat_0=64.7749 +ellps=WGS84&quot;</div><div class="line">BBOX=&quot;21.4998,62.4478,32.0057,66.9162&quot;</div></div><!-- fragment --><p>Further, using <code>&ndash;script</code> one can quickly create similar conf files with a single command: </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> --formatFile radar-conf.tpl --script <span class="stringliteral">&#39;-c --formatOut site-${NOD}.cnf&#39;</span> &lt;volumes.h5&gt;</div></div><!-- fragment --><p> Note that <code>&ndash;script</code> implicitly sets <code>&ndash;expandVariables</code> .</p>
<h1><a class="anchor" id="checkscope"></a>
Does a radar overlap with a given geographical scope?</h1>
<p>Consider generating a composite on a geographical scope defined by a projection and a bounding box. If the area is small with respect to the surrounding radar network, one should not read all the possible radar files at hand, even though <code>Rack</code> will automatically reject volume data which is out of scope. This is especially critical if radar data are archived, needing time-consuming retrieval, uncompressing and format conversion. Hence, one needs a means of advance checking if a radar should be included or not in the composite.</p>
<p>In <b>Rack</b>, commands of type <code>&ndash;/xxx/xxx</code>:yyy=zzz are interpreted as ODIM metadata to be set in the current HDF5 object. <code>Rack</code> always contains one object, initially empty, for which the metadata can be set as well. As for with a true input volume, one can check the geographical scope of this "volume" using <code>&ndash;cBBoxTest</code> command as follows, for example:</p>
<div class="fragment"><div class="line">rack --verbose 0 \</div><div class="line">     --cProj &#39;+proj=stere +lon_0=25.0 +lat_0=60.000&#39; \</div><div class="line">     --cBBox &#39;20,58,30,63&#39; \</div><div class="line">     --/where:lon=26.32  \</div><div class="line">     --/where:lat=64.77  \</div><div class="line">     --/where:nbins=500  \</div><div class="line">     --/where:rscale=500 \</div><div class="line">     --cBBoxTest 1</div><div class="line"></div></div><!-- fragment --><p>The result can be checked from the return code, which is zero if the radar range overlaps with the composite domain, and non-zero otherwise.</p>
<p>Another way is to call <code>&ndash;formatOut</code> for each input volume, using <code>&ndash;format</code> that contains <code>cBBoxTest</code> and other desired status variables. For example: </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a>  --cProj <span class="stringliteral">&#39;+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs&#39;</span> --cBBox 20,60,30,70 \</div><div class="line">  --format <span class="stringliteral">&#39;${cBBoxTest} ${CMT} ${what:source} ${inputFile} \n&#39;</span> \</div><div class="line">  --script <span class="stringliteral">&#39;--cBBoxTest 1 --formatOut -&#39;</span> \</div><div class="line">  --verbose 0 \</div><div class="line">  data/pvol_*</div></div><!-- fragment --><p>Instead of giving <code>nbins</code> and <code>rscale</code> , the range can be given using the non-standard <code>&ndash;where:range</code> directly (in metres, for example 250000).</p>
<p>This command could be called by a script which iterates through sample files, and the results are catenated in a file like </p><div class="fragment"><div class="line"><span class="preprocessor"># FMI radars</span></div><div class="line">fianj=27.1111,60.9036</div><div class="line">fiika=23.08,61.767</div><div class="line">fikor=21.6465,60.1284</div><div class="line">...</div></div><!-- fragment --><p>A further application could be in an operational compositing process, where another script iterates through these entries, testing locations with <code>&ndash;cBBoxTest</code> as shown above and including successful sites in the actual compositing script. A variable names, instead of output of <code>${what:source}</code> above, it is practical to use radar site codes in the form they appear in filenames.</p>
<h1><a class="anchor" id="quantityConf"></a>
Default encoding of quantities</h1>
<p>Measurement parameters of radars have a varying scale. For example, DBZH is typically between -32dBZ and 50dBZ whereas RHOHV ranges between 0.0 and 1.0. Further, different storage types can be used, and the resulting value range should be compatible with the encoding. In some cases, like in creating radar image composites, <b>Rack</b> can use predefined storage types and encoding. The following examples illustrate the usage</p>
<div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> --quantityConf DBZH:S          # <span class="keywordflow">for</span> encoding dBZ, use <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> int, with <span class="keywordflow">default</span> scaling</div><div class="line"><a class="code" href="namespacerack.html">rack</a> --quantityConf DBZH:C,0.6,-30  # <span class="keywordflow">for</span> encoding dBZ, use <span class="keywordtype">unsigned</span> char, with gain=0.5 and offset=-32</div></div><!-- fragment --><p>The arguments can be named explicitly, as in the case of <code>&ndash;select</code> and <code>&ndash;encoding</code> . The encoding of a given quantity is displayed if the quantity is issued without type specifier character. A quantity can be also assigned <code>zero</code>, a "virtual" physical small value to be applied instead of <code>undetect</code> marker.</p>
<div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> --quantityConf <span class="stringliteral">&#39;DBZH&#39;</span></div></div><!-- fragment --><p>yelding </p><div class="fragment"><div class="line">DBZH</div><div class="line"> *  what:type=C,what:gain=0.5,what:offset=-32,what:undetect=0,what:nodata=255 (min=-31.5)</div><div class="line">    what:type=S,what:gain=0.01,what:offset=-327.68,what:undetect=0,what:nodata=65535 (min=-327.67)</div><div class="line">    <span class="keyword">virtual</span> zero=-32</div></div><!-- fragment --><p> where asterisk <code>*</code> marks the current default storage type and scaling.</p>
<p>The full list of predefined quantity encodings are listed with </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> --quantityConf <span class="stringliteral">&#39;&#39;</span></div></div><!-- fragment --><p> One may freely add encodings simply by setting them with <code>&ndash;quantityConf</code> </p>
<h1><a class="anchor" id="testdata"></a>
Creating test volumes</h1>
<p>The following script can be applied to create test volumes.</p>
<div class="fragment"><div class="line">#!/bin/bash</div><div class="line">#</div><div class="line"># Generates an artificial radar volume (chessboard data).</div><div class="line">#</div><div class="line"># Part of Rack distribution</div><div class="line">#</div><div class="line"># Markus.Peura@fmi.fi</div><div class="line"></div><div class="line">PATH=${PATH}&#39;:/fmi/dev/bin&#39;</div><div class="line"></div><div class="line">QUANTITY=${QUANTITY:-&#39;DBZH&#39;}</div><div class="line">OUTDIR=${OUTDIR:-&quot;.&quot;}</div><div class="line">OUTFILE=${OUTFILE:-&quot;testdata-$QUANTITY.h5&quot;}</div><div class="line"></div><div class="line">NBINS=${NBINS:-&#39;500&#39;}</div><div class="line">NRAYS=${NRAYS:-&#39;360&#39;}</div><div class="line">RSCALE=${RSCALE:-&#39;500&#39;}</div><div class="line"></div><div class="line">LON=${LON:-&#39;25.0&#39;}</div><div class="line">LAT=${LAT:-&#39;60.0&#39;}</div><div class="line"></div><div class="line"></div><div class="line">GAIN=${GAIN:-&#39;0.5&#39;}</div><div class="line">OFFSET=${OFFSET:-&#39;-32&#39;}</div><div class="line">UNDETECT=${UNDETECT:-&#39;0&#39;}</div><div class="line">NODATA=${NODATA:-&#39;255&#39;}</div><div class="line"></div><div class="line"># Base &quot;data&quot;: a 2x2 grid replicated over the image</div><div class="line">VALUES=${VALUES:-$(( RANDOM &amp; 127 )),$(( RANDOM &amp; 127 + 128 ))}</div><div class="line">VALUES=${VALUES/:/,}</div><div class="line">#VALUES=${VALUES:-&quot;64:192&quot;}</div><div class="line">VALUES=( ${VALUES/,/ } )</div><div class="line">DARK=${VALUES[0]} </div><div class="line">LIGHT=${VALUES[1]} </div><div class="line">#DARK=$((  RANDOM &amp; 127 ))</div><div class="line">#LIGHT=$(( RANDOM &amp; 127 + 128 ))</div><div class="line">DATA=${DATA:-&quot;$DARK,$LIGHT,$LIGHT,$DARK&quot;}</div><div class="line"></div><div class="line">BASENAME=${OUTFILE%.*}</div><div class="line">IMGFILE=${BASENAME}-raw.png</div><div class="line">TILEFILE=${BASENAME}-tile.png</div><div class="line">CMDFILE=${BASENAME}.sh</div><div class="line"></div><div class="line">#</div><div class="line">if [ &quot;$COORD&quot; == &#39;c&#39; ]; then</div><div class="line">    cart=&#39;-c&#39;</div><div class="line">else</div><div class="line">    cart=&#39;&#39;</div><div class="line">fi</div><div class="line"></div><div class="line"># PALETTE=default</div><div class="line">if [ &quot;$PALETTE&quot; == &#39;default&#39; ]; then</div><div class="line">    PALETTE=$QUANTITY</div><div class="line">fi</div><div class="line">palette=${PALETTE:+&quot;--palette palette/palette-$PALETTE.txt&quot;}</div><div class="line"></div><div class="line"></div><div class="line"># Step 1: create png image file</div><div class="line">echo $(( NBINS / 20 ))x$(( NRAYS / 20 ))</div><div class="line">echo &quot;P2 2 2 255  ${DATA//,/ }&quot; | convert pgm:- -filter Point -resize $(( NBINS / 5 ))x$(( NRAYS / 20 ))\! ${OUTDIR}/${TILEFILE}</div><div class="line"></div><div class="line">if [ ! -s &quot;${OUTDIR}/${TILEFILE}&quot; ]; then</div><div class="line">    echo &quot;502 Could not generate tile file: ${OUTDIR}/${TILEFILE}&quot; </div><div class="line">    exit 1</div><div class="line">fi</div><div class="line"></div><div class="line">if [ &quot;$FORMAT&quot; == &#39;sh&#39; ]; then</div><div class="line">   OUTFILE=${BASENAME}.h5</div><div class="line">fi</div><div class="line"></div><div class="line">   </div><div class="line"></div><div class="line">cat &gt; $OUTDIR/$CMDFILE &lt;&lt;EOF</div><div class="line"># Step 2: expand to a gridded png image</div><div class="line">convert -size ${NBINS}x${NRAYS} tile:$OUTDIR/${TILEFILE} -type GrayScale -depth 8 ${OUTDIR}/${IMGFILE}</div><div class="line"></div><div class="line"># Step 3: add ODIM variables, convert to HDF5</div><div class="line">rack ${OUTDIR}/${IMGFILE} \</div><div class="line">  --/what:object=PVOL \</div><div class="line">  --/where:lon=$LON \</div><div class="line">  --/where:lat=$LAT \</div><div class="line">  --/how:simulated=True \</div><div class="line">  --/dataset1/where:nbins=$NBINS \</div><div class="line">  --/dataset1/where:nrays=$NRAYS \</div><div class="line">  --/dataset1/where:rscale=$RSCALE \</div><div class="line">  --/dataset1/data1/what:quantity=$QUANTITY \</div><div class="line">  --/dataset1/data1/what:gain=$GAIN   \</div><div class="line">  --/dataset1/data1/what:offset=$OFFSET \</div><div class="line">  --completeODIM \</div><div class="line">  ${cart} ${palette} \</div><div class="line">  -o ${OUTDIR}/${OUTFILE}</div><div class="line"></div><div class="line">rm -v $OUTDIR/${IMGFILE} </div><div class="line">rm -v $OUTDIR/${TILEFILE}</div><div class="line">EOF</div><div class="line"></div><div class="line">if [ &quot;$FORMAT&quot; != &#39;sh&#39; ]; then</div><div class="line">   source $OUTDIR/$CMDFILE</div><div class="line">fi</div><div class="line"></div><div class="line"># That&#39;s it</div></div><!-- fragment --><div class="image">
<img src="test-sweep-both.png" alt="test-sweep-both.png"/>
<div class="caption">
Test data in its original polar coordinates and Cartesian projection.</div></div>
  </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
